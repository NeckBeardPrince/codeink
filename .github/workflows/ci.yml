name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Build Docker image
        run: docker build -t codeink:test .

      - name: Verify container starts
        run: |
          docker run -d --name codeink-test -p 8080:80 codeink:test
          sleep 2
          curl -f http://localhost:8080/ || (docker logs codeink-test && exit 1)
          docker stop codeink-test

  html-validate:
    name: Validate HTML
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check for broken CDN links
        run: |
          echo "Checking highlight.js CDN links..."
          grep -oP 'https://cdnjs\.cloudflare\.com[^"]+' static/index.html | while read url; do
            echo "  Checking: $url"
            curl -sf --head "$url" > /dev/null || { echo "  BROKEN: $url"; exit 1; }
          done
          echo "All CDN links valid."
